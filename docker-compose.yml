services:
  # ===========================================
  # Backend (Go API)
  # ===========================================
  # Note: Requires local Supabase running (make supabase-start)
  backend:
    build:
      context: .
      dockerfile: apps/api/Dockerfile.dev
    ports:
      - "8080:8080"
    volumes:
      - .:/app
      - ./.keys:/app/.keys:ro
      - go_mod_cache:/go/pkg/mod
      - /var/run/docker.sock:/var/run/docker.sock
    env_file:
      - ./apps/api/.env
    environment:
      # Override to use Supabase's Postgres via host network
      - DATABASE_URL=postgresql://postgres:postgres@host.docker.internal:54322/postgres?sslmode=disable
      # Override Supabase URL to use host network
      - SUPABASE_URL=http://host.docker.internal:54321
      # LOCAL_MODE paths - must be absolute host paths for Docker-in-Docker volume mounts
      # These are set by the Makefile (make dev-services)
      - LOCAL_PROJECT_DIR=${LOCAL_PROJECT_DIR}
      - LOCAL_WORKSPACE_SERVICE_DIR=${LOCAL_WORKSPACE_SERVICE_DIR}
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      - aether

  # ===========================================
  # Gateway (Preview URL proxy)
  # ===========================================
  # Routes {port}-{projectId}.localhost:8081 to Docker containers
  gateway:
    build:
      context: .
      dockerfile: apps/gateway/Dockerfile.dev
    ports:
      - "8081:8080"
    volumes:
      - .:/app
      - go_mod_cache:/go/pkg/mod
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - LOCAL_MODE=true
      - DATABASE_URL=postgresql://postgres:postgres@host.docker.internal:54322/postgres?sslmode=disable
      - PREVIEW_DOMAIN=localhost
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      - aether

networks:
  aether:
    name: aether
    driver: bridge

volumes:
  go_mod_cache:
